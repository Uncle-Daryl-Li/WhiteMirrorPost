<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>WhiteMirror - Workspace</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&display=swap" rel="stylesheet">

<style>
  /* --- 1. å…¨å±€åŸºç¡€è®¾ç½® --- */
  :root {
    --sidebar-width: 320px;
    --sidebar-collapsed-width: 80px;
    --bg-color: #F9FAFB;
    --text-primary: #111111;
    --text-secondary: #6B7280;
    --border-color: #E5E7EB;
    --primary-blue: #3B82F6;
    --hover-bg: #F3F4F6;
    --icon-color: #9CA3AF;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
    background-color: var(--bg-color);
    color: var(--text-primary);
    height: 100vh; display: flex; overflow: hidden;
    transition: all 0.3s ease;
    position: relative;
  }

  /* =========================================
     ã€æå…‰ç³»ç»Ÿã€‘
   ========================================= */
  .aurora-container {
    position: absolute;
    top: 0; left: 0; width: 100%; height: 480px;
    z-index: 0; pointer-events: none;
    opacity: 0.9; filter: blur(60px);
    transform-origin: center top;
    transition: all 1.2s cubic-bezier(0.25, 0.46, 0.45, 0.94);
    display: flex; justify-content: center;
  }

  .aurora-lights {
    width: 100%; height: 100%;
    /* ç²‰ç´«åœ¨ä¸Šï¼Œé’ç»¿åœ¨ä¸­(è¦†ç›–æ ‡é¢˜)ï¼Œåº•éƒ¨é€æ˜ */
    background: linear-gradient(to bottom,
      rgba(236, 72, 153, 0.6) 0%,
      rgba(167, 139, 250, 0.5) 20%,
      rgba(34, 211, 238, 0.55) 40%,
      rgba(34, 211, 238, 0.3) 75%,
      transparent 100%);
    background-size: 100% 150%;
    border-radius: 0 0 20% 20% / 0 0 10% 10%;
    animation: aurora-flow 10s infinite ease-in-out alternate;
  }

  @keyframes aurora-flow {
    0% { background-position: 50% 0%; }
    100% { background-position: 50% 20%; }
  }

  /* äº¤äº’çŠ¶æ€ */
  .aurora-container.wave-active { opacity: 1; transform: translateY(20px); }
  .aurora-container.wave-active .aurora-lights { animation: liquid-morph 4s infinite ease-in-out; }

  @keyframes liquid-morph {
    0% { border-radius: 0 0 20% 20% / 0 0 10% 10%; transform: scaleY(1); }
    25% { border-radius: 0 0 30% 70% / 0 0 20% 15%; transform: scaleY(1.1); }
    50% { border-radius: 0 0 50% 50% / 0 0 30% 30%; transform: scaleY(1.15) translateY(10px); }
    75% { border-radius: 0 0 70% 30% / 0 0 15% 20%; transform: scaleY(1.1); }
    100% { border-radius: 0 0 20% 20% / 0 0 10% 10%; transform: scaleY(1); }
  }

  /* å…¥åœºåŠ¨ç”»ï¼šé’ˆå¯¹ç»å¯¹å®šä½å±…ä¸­å…ƒç´ ï¼ˆç”¨äºå¤§æ ‡é¢˜ï¼‰ */
  @keyframes slideUpFadeInCentered {
    0% {
      opacity: 0;
      /* ä¿æŒæ°´å¹³å±…ä¸­ï¼Œå‚ç›´æ–¹å‘ä»ä¸‹æ–¹40pxå¤„å¼€å§‹ */
      transform: translate(-50%, calc(-50% + 40px));
      filter: blur(10px);
    }
    100% {
      opacity: 1;
      transform: translate(-50%, -50%);
      filter: blur(0);
    }
  }

  /* å…¥åœºåŠ¨ç”»ï¼šé’ˆå¯¹æ™®é€šæ–‡æ¡£æµå…ƒç´ ï¼ˆç”¨äºè¾“å…¥æ¡†ï¼‰ */
  @keyframes slideUpFadeInNormal {
    0% {
      opacity: 0;
      transform: translateY(40px);
      filter: blur(10px);
    }
    100% {
      opacity: 1;
      transform: translateY(0);
      filter: blur(0);
    }
  }

  /* é€€åœºåŠ¨ç”»ï¼šæ—§æ ‡é¢˜ç¼©å°å¸å…¥è¾“å…¥æ¡†ï¼ˆä¿®å¤åŠ¨ç”»å†²çªçš„å…³é”®ï¼‰ */
  @keyframes fadeOutDownToInput {
    from {
      opacity: 1;
      transform: translate(-50%, -50%) scale(1);
    }
    to {
      opacity: 0;
      transform: translate(-50%, 150%) scale(0.2);
    }
  }

  .aurora-container.absorbed {
    top: 50%; width: 100%; left: 0;
    transform: translateY(-50%) scale(0.1);
    filter: blur(100px); opacity: 0;
    transform-origin: center center;
    transition: all 1.2s cubic-bezier(0.7, 0, 0.3, 1);
  }

  /* --- å·¦ä¾§ä¾§è¾¹æ  (ä¿æŒä¸å˜) --- */
  .sidebar { width: var(--sidebar-width); background-color: #FFFFFF; border-right: 1px solid var(--border-color); display: flex; flex-direction: column; z-index: 20; height: 100%; transition: width 0.3s cubic-bezier(0.4, 0, 0.2, 1); overflow: hidden; }
  .sidebar-header { padding: 20px; display: flex; align-items: center; justify-content: space-between; flex-shrink: 0; }
  .app-logo { display: flex; align-items: center; gap: 12px; text-decoration: none; color: inherit; overflow: hidden; white-space: nowrap; }
  .app-logo img { height: 32px; width: auto; flex-shrink: 0; }
  .app-logo span { font-weight: 700; font-size: 18px; letter-spacing: -0.02em; transition: opacity 0.2s; }
  .toggle-sidebar-btn { background: transparent; border: none; cursor: pointer; padding: 8px; border-radius: 8px; color: var(--text-secondary); display: flex; align-items: center; justify-content: center; transition: all 0.3s ease; flex-shrink: 0; }
  .toggle-sidebar-btn:hover { background-color: var(--hover-bg); color: var(--text-primary); }
  .toggle-icon-svg { transition: transform 0.3s ease; }
  .sidebar-scroll-area { flex: 1; overflow-y: auto; overflow-x: hidden; padding: 10px 16px 24px 16px; scrollbar-width: thin; }
  .user-profile { padding: 20px; border-top: 1px solid var(--border-color); display: flex; align-items: center; gap: 12px; cursor: pointer; transition: all 0.2s; flex-shrink: 0; background: #FFFFFF; }
  .user-profile:hover { background-color: var(--hover-bg); }
  .avatar { width: 36px; height: 36px; border-radius: 50%; background: #000; color: #fff; display: flex; align-items: center; justify-content: center; font-weight: 600; font-size: 14px; flex-shrink: 0; }
  .user-info { overflow: hidden; white-space: nowrap; transition: opacity 0.2s; }
  .user-info h4 { font-size: 14px; font-weight: 600; color: var(--text-primary); margin: 0; }
  .user-info p { font-size: 12px; color: var(--text-secondary); margin: 2px 0 0 0; }
  details.settings-card { background: transparent; border: none; border-radius: 12px; margin-bottom: 8px; overflow: hidden; transition: all 0.2s ease; }
  details.settings-card[open] .card-content { background: #fff; border: 1px solid var(--border-color); border-radius: 12px; margin-top: 8px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05); animation: slideDown 0.2s ease-out; }
  @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
  summary { list-style: none; padding: 12px; font-weight: 600; font-size: 14px; color: var(--text-primary); cursor: pointer; display: flex; align-items: center; justify-content: space-between; background: transparent; border-radius: 12px; transition: all 0.2s; user-select: none; }
  summary::-webkit-details-marker { display: none; }
  summary:hover { background-color: var(--hover-bg); }
  .summary-title { display: flex; align-items: center; gap: 12px; white-space: nowrap; }
  .menu-icon { width: 20px; height: 20px; color: var(--text-secondary); flex-shrink: 0; transition: color 0.2s; }
  summary:hover .menu-icon { color: var(--text-primary); }
  .arrow-icon { width: 16px; height: 16px; color: var(--text-secondary); transition: transform 0.2s ease; opacity: 0; }
  summary:hover .arrow-icon { opacity: 1; }
  details[open] summary .arrow-icon { transform: rotate(90deg); opacity: 1; }
  .card-content { padding: 16px; }
  body.sidebar-collapsed .sidebar { width: var(--sidebar-collapsed-width); }
  body.sidebar-collapsed .sidebar-header { flex-direction: column; gap: 16px; padding: 20px 0; }
  body.sidebar-collapsed .app-logo span { display: none; }
  body.sidebar-collapsed .toggle-icon-svg { transform: rotate(180deg); }
  body.sidebar-collapsed summary { justify-content: center; padding: 12px 0; }
  body.sidebar-collapsed .summary-text { display: none; }
  body.sidebar-collapsed .arrow-icon { display: none !important; }
  body.sidebar-collapsed .summary-title { gap: 0; }
  body.sidebar-collapsed .card-content { display: none; }
  body.sidebar-collapsed .user-info { display: none; }
  body.sidebar-collapsed .user-profile { justify-content: center; padding: 20px 0; }
  .control-group { margin-bottom: 16px; } .label-row { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 12px; font-weight: 500; color: var(--text-secondary); } .select-wrapper { position: relative; } .modern-select { width: 100%; appearance: none; padding: 10px 12px 10px 36px; border: 1px solid var(--border-color); border-radius: 8px; font-size: 14px; color: var(--text-primary); background: #fff; outline: none; cursor: pointer; transition: border 0.2s; } .modern-select:focus { border-color: var(--primary-blue); } .select-icon { position: absolute; left: 10px; top: 50%; transform: translateY(-50%); width: 16px; height: 16px; color: var(--text-secondary); pointer-events: none; } .select-arrow { position: absolute; right: 12px; top: 50%; transform: translateY(-50%); width: 12px; height: 12px; color: var(--text-secondary); pointer-events: none; } .slider-container { width: 100%; } .slider-range { -webkit-appearance: none; width: 100%; height: 6px; background: #E5E7EB; border-radius: 99px; outline: none; background-image: linear-gradient(var(--primary-blue), var(--primary-blue)); background-size: 0% 100%; background-repeat: no-repeat; cursor: pointer; } .slider-range::-webkit-slider-thumb { -webkit-appearance: none; height: 16px; width: 16px; border-radius: 50%; background: #fff; border: 2px solid var(--primary-blue); box-shadow: 0 2px 4px rgba(0,0,0,0.1); transition: transform 0.1s; } .slider-range:active::-webkit-slider-thumb { transform: scale(1.2); } .slider-labels { display: flex; justify-content: space-between; font-size: 10px; color: #9CA3AF; margin-top: 6px; } .dropzone { border: 1px dashed #D1D5DB; border-radius: 8px; padding: 16px; text-align: center; transition: all 0.2s; cursor: pointer; margin-bottom: 12px; background: #F9FAFB; } .dropzone:hover { border-color: var(--primary-blue); background: #EFF6FF; } .dz-icon { color: var(--text-secondary); margin-bottom: 4px; } .dz-text { font-size: 12px; color: var(--text-secondary); } .dz-btn { font-size: 10px; padding: 4px 8px; border: 1px solid #E5E7EB; background: #fff; border-radius: 4px; margin-top: 8px; display: inline-block; } .checkbox-wrapper { display: flex; align-items: center; gap: 8px; margin-bottom: 16px; } .custom-checkbox { accent-color: var(--primary-blue); } .checkbox-label { font-size: 12px; color: var(--text-secondary); } .manage-link { display: flex; align-items: center; justify-content: center; gap: 6px; width: 100%; padding: 8px; font-size: 12px; color: var(--primary-blue); font-weight: 600; background: #EFF6FF; border-radius: 6px; text-decoration: none; transition: background 0.2s; } .manage-link:hover { background: #DBEAFE; } .negative-input { width: 100%; height: 80px; padding: 10px; border: 1px solid var(--border-color); border-radius: 8px; font-family: inherit; font-size: 12px; resize: none; outline: none; background: #F9FAFB; } .negative-input:focus { border-color: var(--primary-blue); background: #fff; } .model-card { display: flex; align-items: center; gap: 12px; padding: 12px; background: #EFF6FF; border: 1px solid #BFDBFE; border-left: 4px solid var(--primary-blue); border-radius: 6px; margin-bottom: 16px; } .model-icon { width: 32px; height: 32px; background: #fff; border-radius: 6px; display: flex; align-items: center; justify-content: center; font-size: 16px; } .model-info h4 { font-size: 13px; font-weight: 700; color: #1E3A8A; } .model-info p { font-size: 10px; color: #3B82F6; margin-top: 2px; } .toggle-wrapper { display: flex; justify-content: space-between; align-items: center; } .toggle-label { font-size: 13px; font-weight: 500; display: flex; align-items: center; gap: 6px; } .help-icon { width: 14px; height: 14px; color: #9CA3AF; cursor: help; } .toggle-switch { position: relative; display: inline-block; width: 36px; height: 20px; } .toggle-switch input { opacity: 0; width: 0; height: 0; } .slider-round { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #E5E7EB; border-radius: 34px; transition: .4s; } .slider-round:before { position: absolute; content: ""; height: 16px; width: 16px; left: 2px; bottom: 2px; background-color: white; border-radius: 50%; transition: .4s; box-shadow: 0 1px 3px rgba(0,0,0,0.2); } input:checked + .slider-round { background-color: var(--primary-blue); } input:checked + .slider-round:before { transform: translateX(16px); }

  /* å³ä¾§ä¸»å†…å®¹ */
  .main-content { flex: 1; display: flex; flex-direction: column; position: relative; overflow-y: auto; justify-content: center; z-index: 10; }

  /* æ ‡é¢˜å®¹å™¨ */
  .workspace-header {
    padding: 0 40px;
    display: flex; justify-content: center; align-items: center;
    position: relative; height: 100px;
    flex-shrink: 0;
  }

  /* ==================================================
     ã€æ ¸å¿ƒä¿®å¤åŒºã€‘ æ ‡é¢˜åŠ¨ç”»é€»è¾‘ (Animation Fix)
     ================================================== */

  /* 1. åˆå§‹æ ‡é¢˜æ ·å¼ */
  #mainTitle {
    font-size: 36px; font-weight: 900; color: #000; text-align: center;
    position: absolute; top: 50%; left: 50%;
    z-index: 1; white-space: nowrap;

    /* åˆå§‹ä¸å¯è§ï¼Œæ‰§è¡Œã€å…¥åœºåŠ¨ç”»ã€‘ */
    opacity: 0;
    animation: slideUpFadeInCentered 1s cubic-bezier(0.2, 0.8, 0.2, 1) 0.2s forwards;
  }

  /* 2. ç‚¹å‡»åï¼šè¢« JS æ·»åŠ  .fade-in-input ç±»æ—¶çš„æ ·å¼ */
  /* ä½¿ç”¨é«˜ä¼˜å…ˆçº§é€‰æ‹©å™¨ï¼Œå¼ºåˆ¶è¦†ç›–å…¥åœºåŠ¨ç”» */
  #mainTitle.fade-in-input {
    /* æ‰§è¡Œã€é€€åœºåŠ¨ç”»ã€‘ */
    animation: fadeOutDownToInput 1.5s cubic-bezier(0.65, 0, 0.35, 1) forwards;
  }

  /* 3. æ–°æ ‡é¢˜æ ·å¼ */
  #newTitle {
    position: absolute;
    top: 50%; left: 50%;
    transform: translate(-50%, 150%) scale(0.2); opacity: 0;
    transition: all 0.8s cubic-bezier(0.16, 1, 0.3, 1);
    z-index: 2;
    clip-path: inset(0);
    white-space: nowrap;
    will-change: transform, opacity;
  }
  #newTitle.pop-out { transform: translate(-50%, -50%) scale(1); opacity: 1; }

  /* æ–°æ ‡é¢˜æ–‡å­—å†…å®¹ */
  #newTitle .text-content {
    display: inline-block;
    font-size: 36px; font-weight: 900;
    background-image: linear-gradient(to right, #2563EB, #7C3AED, #DB2777);
    -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent;
  }

  /* å‰¯æ ‡é¢˜å®¹å™¨ - "æµ·æŠ¥æ­£åœ¨ç”Ÿæˆä¸­..." */
  #loadingSubtext {
    position: absolute;
    top: calc(50% + 35px); left: 50%;
    transform: translate(-50%, 20px); opacity: 0;
    transition: all 1s cubic-bezier(0.2, 0.8, 0.2, 1);
    z-index: 2; pointer-events: none;
    clip-path: inset(0);
    white-space: nowrap;
    will-change: transform, opacity;
  }
  #loadingSubtext.show { opacity: 1; transform: translate(-50%, 0); }

  /* å‰¯æ ‡é¢˜æ–‡å­— */
  #loadingSubtext .text-content {
    display: inline-block;
    font-size: 14px; font-weight: 500; color: #6B7280; letter-spacing: 1px;
  }

  /* --- æ‰«æå…‰æ•ˆ --- */
  .scan-effect { overflow: hidden; }

  .scan-effect::after {
    content: ''; position: absolute;
    top: 0; left: -100%; width: 60%; height: 100%;
    background: linear-gradient(90deg, transparent 0%, rgba(255, 255, 255, 0.9) 50%, transparent 100%);
    transform: skewX(-20deg);
    animation: scan-move 2.5s cubic-bezier(0.4, 0.0, 0.2, 1) infinite;
    pointer-events: none; mix-blend-mode: overlay;
  }

  .scan-effect .text-content { animation: scan-shrink 2.5s cubic-bezier(0.4, 0.0, 0.2, 1) infinite; }

  @keyframes scan-move { 0% { left: -100%; } 100% { left: 200%; } }
  @keyframes scan-shrink { 0%, 100% { transform: scale(1); } 50% { transform: scale(0.95); } }

  /* ================================================== */

  /* åˆ›ä½œåŒºåŸŸï¼ˆè¾“å…¥æ¡†ï¼‰ */
  .creation-area {
    max-width: 800px; margin: 20px auto; width: 90%;
    text-align: center; position: relative; z-index: 2;
    transition: all 0.5s ease; /* æ•´ä½“æ·¡å‡º */
  }
  .creation-area.fade-out { opacity: 0; transform: scale(0.95); pointer-events: none; }

  /* éœ“è™¹æ—‹è½¬ */
  .magic-input-box-wrapper {
    position: relative;
    width: 100%;
    border: 1px solid #E5E7EB; border-radius: 24px; padding: 16px 24px;
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
    display: flex; flex-direction: column;
    z-index: 5;
    overflow: visible; /* å…è®¸ popover èœå•æ˜¾ç¤ºåœ¨å®¹å™¨å¤– */
    background: transparent; /* æ”¹ä¸ºé€æ˜ï¼Œè®©åº•å±‚éœ“è™¹å…‰å¯ä»¥é€è¿‡æ¥ */

    /* åˆå§‹ä¸å¯è§ï¼Œæ‰§è¡Œå…¥åœºåŠ¨ç”»ï¼ˆæ¯”æ ‡é¢˜æ™š 0.2sï¼‰ */
    opacity: 0;
    animation: slideUpFadeInNormal 1s cubic-bezier(0.2, 0.8, 0.2, 1) 0.4s forwards;

    transition: border-color 0.3s, box-shadow 0.3s, opacity 0.3s;
  }

  .magic-input-box-wrapper:focus-within { border-color: #3B82F6; box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1); }

  /* éœ“è™¹å…‰æŸ (ä¼ªå…ƒç´ ) - å•æ¡å…‰æŸæ—‹è½¬ */
  .magic-input-box-wrapper::before {
    content: '';
    position: absolute;
    inset: -3px; /* æ¯”è¾“å…¥æ¡†å¤§ 3px */
    background: conic-gradient(
      from 0deg at 50% 50%,
      transparent 0deg,
      transparent 270deg,
      #0E7490 290deg,
      #8B5CF6 320deg,
      #EC4899 340deg,
      transparent 360deg
    );
    border-radius: 27px;
    z-index: -2; /* æ”¾åœ¨æœ€åº•å±‚ */
    opacity: 0;
    /* è¿‡æ¸¡æ—¶é—´ 0.8sï¼Œä¸æ–°æ ‡é¢˜åŒæ­¥ */
    transition: opacity 0.8s ease;
    transform-origin: center center; /* ç¡®ä¿ä»¥è‡ªå·±çš„ä¸­å¿ƒæ—‹è½¬ */
  }

  /* ç™½è‰²é®ç½©å±‚ - å†…ç¼©ç•™å‡ºè¾¹ç¼˜ç¼éš™ï¼Œè®©éœ“è™¹å…‰é€å‡º */
  .magic-input-box-wrapper::after {
    content: '';
    position: absolute;
    inset: 3px; /* å†…ç¼©3pxï¼Œè¾¹ç¼˜ç•™å‡ºç¼éš™ */
    background: #FFFFFF;
    border-radius: 21px; /* é€‚é…å†…ç¼©å°ºå¯¸ (24px - 3px = 21px) */
    z-index: -1; /* åœ¨éœ“è™¹å…‰ä¹‹ä¸Šï¼Œä½†åœ¨å†…å®¹ä¹‹ä¸‹ */
  }

  /* æ¿€æ´»çŠ¶æ€ */
  .magic-input-box-wrapper.neon-active::before {
    opacity: 1;
    animation: rotate-neon-border 2.5s linear infinite;
  }

  @keyframes rotate-neon-border {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
  }

  .magic-textarea {
    flex: 1; width: 100%; height: 28px; border: none; resize: none; outline: none;
    font-family: 'Inter', sans-serif; font-size: 18px; line-height: 1.6;
    color: var(--text-primary); background: transparent; padding: 0; margin-bottom: 12px;
  }
  .magic-textarea::placeholder { color: #9CA3AF; }

  /* åº•éƒ¨æ“ä½œæ  */
  .input-box-actions { display: flex; justify-content: space-between; align-items: center; }
  .left-actions { display: flex; gap: 12px; /* Removed position: relative */ }
  .right-actions { display: flex; align-items: center; gap: 12px; }
  .action-icon-btn, .pro-brain-btn, .generate-arrow-btn {
    display: flex; align-items: center; justify-content: center;
    width: 36px; height: 36px; border-radius: 50%; border: none; cursor: pointer; transition: all 0.2s; position: relative;
  }
  .action-icon-btn, .pro-brain-btn { background: #F3F4F6; color: var(--icon-color); }
  .action-icon-btn:hover, .pro-brain-btn:hover { background: #E5E7EB; color: var(--text-primary); }
  .generate-arrow-btn { background: var(--text-primary); color: #FFFFFF; overflow: hidden; }
  .generate-arrow-btn:hover { background: #000000; transform: scale(1.05); }
  .action-svg-icon { width: 20px; height: 20px; }
  .mic-icon, .arrow-up-icon { width: 20px; height: 20px; position: absolute; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
  .mic-icon { transform: translateY(0); opacity: 1; }
  .arrow-up-icon { transform: translateY(100%); opacity: 0; }
  .generate-arrow-btn.show-arrow .mic-icon { transform: translateY(-100%); opacity: 0; }
  .generate-arrow-btn.show-arrow .arrow-up-icon { transform: translateY(0); opacity: 1; }
  .brain-icon, .lightning-icon { width: 20px; height: 20px; position: absolute; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
  .brain-icon { transform: scale(1); opacity: 1; }
  .lightning-icon { transform: scale(0.5); opacity: 0; }
  .pro-brain-btn.show-lightning .brain-icon { transform: scale(0.5); opacity: 0; }
  .pro-brain-btn.show-lightning .lightning-icon { transform: scale(1); opacity: 1; }
  /* Modified Popover Menu Styles - æ˜¾ç¤ºåœ¨è¾“å…¥æ¡†ä¸‹æ–¹ */
  .popover-menu {
    visibility: hidden;
    opacity: 0;
    position: absolute;
    top: calc(100% + 10px); /* Position below the input box */
    left: 24px; /* Align with padding */
    background: #FFFFFF;
    border-radius: 12px;
    box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
    padding: 8px;
    z-index: 20;
    transform: translateY(-10px); /* Start slightly above */
    transition: all 0.2s ease-out;
    min-width: 200px;
  }
  .popover-menu.active {
    visibility: visible;
    opacity: 1;
    transform: translateY(0); /* Animate to final position */
  }
  .popover-list { list-style: none; padding: 0; margin: 0; }
  .popover-item { display: flex; align-items: center; gap: 12px; padding: 10px 12px; border-radius: 8px; color: var(--text-primary); font-size: 14px; font-weight: 500; cursor: pointer; transition: background 0.2s; }
  .popover-item:hover { background: var(--hover-bg); }
  .popover-icon { width: 20px; height: 20px; color: var(--icon-color); }
  .tooltip {
    visibility: hidden; width: max-content; background-color: #FFFFFF; color: #4B5563;
    text-align: center; padding: 8px 12px; border-radius: 8px;
    position: absolute; z-index: 10; bottom: calc(100% + 10px); left: 50%;
    transform: translateX(-50%); opacity: 0; transition: opacity 0.2s;
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); font-size: 14px; font-weight: 500; pointer-events: none;
  }
  .action-icon-btn:hover .tooltip, .pro-brain-btn:hover .tooltip, .generate-arrow-btn:hover .tooltip { visibility: visible; opacity: 1; }

  /* =========================================
     ã€å›¾ç‰‡é¢„è§ˆåŒºåŸŸ (Image Preview)ã€‘
   ========================================= */
  .image-preview-container {
    margin-bottom: 16px;
    animation: slideDown 0.3s ease-out;
  }
  @keyframes slideDown {
    from { opacity: 0; transform: translateY(-10px); }
    to { opacity: 1; transform: translateY(0); }
  }
  .image-preview-card {
    position: relative;
    width: 120px;
    height: 120px;
    border-radius: 12px;
    overflow: hidden;
    border: 2px solid var(--border-color);
    background: #fff;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
  }
  .image-preview-card img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }
  .remove-image-btn {
    position: absolute;
    top: 4px;
    right: 4px;
    width: 24px;
    height: 24px;
    border-radius: 50%;
    background: rgba(0, 0, 0, 0.7);
    border: none;
    color: white;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0;
    transition: opacity 0.2s, background 0.2s;
  }
  .image-preview-card:hover .remove-image-btn {
    opacity: 1;
  }
  .remove-image-btn:hover {
    background: rgba(220, 38, 38, 0.9);
  }
  .image-label {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    background: linear-gradient(to top, rgba(0, 0, 0, 0.8), transparent);
    color: white;
    font-size: 11px;
    padding: 6px 8px 4px;
    text-align: center;
    font-weight: 500;
  }

  /* =========================================
     ã€æ–°å¢ï¼šç»“æœå±•ç¤ºåŒº (Results View)ã€‘
   ========================================= */
  .results-view {
    position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
    width: 90%; max-width: 1000px;
    display: none; /* é»˜è®¤éšè— */
    flex-direction: column; align-items: center;
    z-index: 20;
  }
  .results-view.active { display: flex; animation: fadeInUp 0.8s cubic-bezier(0.16, 1, 0.3, 1) forwards; }

  @keyframes fadeInUp {
    from { opacity: 0; transform: translate(-50%, -40%); }
    to { opacity: 1; transform: translate(-50%, -50%); }
  }

  .results-header { text-align: center; margin-bottom: 32px; }
  .results-header h2 { font-size: 24px; font-weight: 800; color: var(--text-primary); margin-bottom: 8px; }
  .results-header p { font-size: 14px; color: var(--text-secondary); }

  .results-grid {
    display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; width: 100%; margin-bottom: 32px;
  }
  .result-card {
    aspect-ratio: 2/3; background: #fff; border: 1px solid var(--border-color);
    border-radius: 12px; overflow: hidden; position: relative;
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
    transition: transform 0.2s;
  }
  .result-card:hover { transform: translateY(-4px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }
  /* æ¨¡æ‹Ÿå›¾ç‰‡å ä½ */
  .result-placeholder {
    width: 100%; height: 100%; background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%);
    display: flex; align-items: center; justify-content: center; color: #9ca3af; font-size: 12px;
  }

  .regenerate-bar {
    display: flex; align-items: center; gap: 12px;
    background: #fff; border: 1px solid var(--border-color);
    padding: 8px 8px 8px 16px; border-radius: 12px;
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
  }
  .regen-input { border: none; outline: none; font-size: 14px; width: 300px; color: var(--text-primary); }
  .regen-btn {
    background: var(--text-primary); color: #fff; border: none;
    padding: 8px 16px; border-radius: 8px; font-size: 13px; font-weight: 600; cursor: pointer;
    transition: background 0.2s;
  }
  .regen-btn:hover { background: #000; }
  .back-btn {
    background: transparent; color: var(--text-secondary); border: none;
    padding: 8px 12px; border-radius: 8px; font-size: 13px; font-weight: 600; cursor: pointer;
  }
  .back-btn:hover { background: var(--hover-bg); color: var(--text-primary); }

</style>
</head>
<body class="sidebar-collapsed">

  <div class="aurora-container" id="auroraLayer">
    <div class="aurora-lights"></div>
  </div>

  <aside class="sidebar">
    <div class="sidebar-header">
      <a href="index.html" class="app-logo">
        <img src="logo.png" alt="WhiteMirror">
        <span>WhiteMirror</span>
      </a>
      <button class="toggle-sidebar-btn" id="toggleSidebar" title="Toggle Sidebar">
        <svg class="toggle-icon-svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><line x1="9" y1="3" x2="9" y2="21"></line><path d="M15 10l-2 2 2 2"></path></svg>
      </button>
    </div>
    <div class="sidebar-scroll-area">
      <details class="settings-card"><summary><div class="summary-title"><svg class="menu-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="7" height="7"></rect><rect x="14" y="3" width="7" height="7"></rect><rect x="14" y="14" width="7" height="7"></rect><rect x="3" y="14" width="7" height="7"></rect></svg><span class="summary-text">ç”Ÿæˆè®¾ç½®</span></div><svg class="arrow-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"></polyline></svg></summary><div class="card-content"><div class="control-group"><div class="label-row"><span>æµ·æŠ¥æ¯”ä¾‹</span></div><div class="select-wrapper"><svg class="select-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="5" y="3" width="14" height="18" rx="2"></rect></svg><select id="aspect-ratio-select" class="modern-select"><option value="9:16">9:16 (æŠ–éŸ³/Story)</option><option value="16:9">16:9 (æ¨ªå±è§†é¢‘)</option><option value="1:1">1:1 (Instagram)</option><option value="3:4">3:4 (å°çº¢ä¹¦)</option><option value="4:3">4:3 (ä¼ ç»Ÿåª’ä½“)</option></select><svg class="select-arrow" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"></polyline></svg></div></div><div class="control-group"><div class="label-row"><span>ç”Ÿæˆæ•°é‡</span><span id="count-val" style="color:#0E7490; font-weight:700;">4</span></div><div class="slider-container"><input type="range" min="1" max="10" value="4" class="slider-range" id="count-slider" oninput="updateSlider(this, 'count-val')"><div class="slider-labels"><span>1</span><span>10</span></div></div></div></div></details>
      <details class="settings-card"><summary><div class="summary-title"><svg class="menu-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg><span class="summary-text">å†å²å¯¹è¯</span></div><svg class="arrow-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"></polyline></svg></summary><div class="card-content"><p style="font-size: 12px; color: var(--text-secondary); text-align: center; padding: 20px 0;">æš‚æ— å†å²è®°å½•</p></div></details>
      <details class="settings-card"><summary><div class="summary-title"><svg class="menu-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 20h9"></path><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"></path></svg><span class="summary-text">é£æ ¼åº“</span></div><svg class="arrow-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"></polyline></svg></summary><div class="card-content"><div class="control-group"><div class="label-row"><span>é¢„è®¾é£æ ¼</span></div><div class="select-wrapper"><svg class="select-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 19l7-7 3 3-7 7-3-3z"></path><path d="M18 13l-1.5-7.5L2 2l3.5 14.5L13 18l5-5z"></path><path d="M2 2l7.586 7.586"></path><circle cx="11" cy="11" r="2"></circle></svg><select id="preset-style-select" class="modern-select"><option value="auto">âœ¨ è‡ªåŠ¨åŒ¹é… (Auto)</option><option value="minimal">âšª æç®€ä¸»ä¹‰ (Minimalist)</option><option value="tech">ğŸ”µ å•†åŠ¡ç§‘æŠ€ (Tech)</option><option value="warm">ğŸŸ  æ¸©æš–æ‰‹ç»˜ (Hand-drawn)</option></select><svg class="select-arrow" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"></polyline></svg></div></div><div class="control-group"><div class="label-row"><span>é£æ ¼å¼ºåº¦</span><span id="strength-val" style="color:#0E7490; font-weight:700;">0.65</span></div><div class="slider-container"><input type="range" min="0" max="1" step="0.01" value="0.65" class="slider-range" id="strength-slider" oninput="updateSlider(this, 'strength-val')"><div class="slider-labels"><span>0.00</span><span>1.00</span></div></div></div></div></details>
      <details class="settings-card"><summary><div class="summary-title"><svg class="menu-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg><span class="summary-text">ç´ æç®¡ç†</span></div><svg class="arrow-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"></polyline></svg></summary><div class="card-content"><div class="control-group"><div class="label-row"><span>Logo ä¸Šä¼ </span></div><div class="dropzone"><div class="dz-icon"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg></div><div class="dz-text">æ‹–æ‹½æˆ–ç‚¹å‡»ä¸Šä¼ </div><span class="dz-btn">æµè§ˆ...</span></div><div class="checkbox-wrapper"><input type="checkbox" id="auto-logo" class="custom-checkbox" checked><label for="auto-logo" class="checkbox-label">è‡ªåŠ¨æ·»åŠ åˆ°ç”»é¢</label></div></div><div class="control-group"><div class="label-row"><span>äºŒç»´ç  ä¸Šä¼ </span></div><div class="dropzone"><div class="dz-icon"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7"></rect><rect x="14" y="3" width="7" height="7"></rect><rect x="14" y="14" width="7" height="7"></rect><rect x="3" y="14" width="7" height="7"></rect></svg></div><div class="dz-text">æ‹–æ‹½æˆ–ç‚¹å‡»ä¸Šä¼ </div></div></div><a href="#" class="manage-link">ç®¡ç†æ•´ä¸ªç´ æåº“<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 18 15 12 9 6"></polyline></svg></a></div></details>
    </div>
    <div class="user-profile"><div class="avatar">U</div><div class="user-info"><h4>User Name</h4><p>Pro Plan</p></div></div>
  </aside>

  <main class="main-content">
    <header class="workspace-header">
      <div class="header-title">
        <h1 id="mainTitle" class="title-text">å‡†å¤‡å¥½åˆ›ä½œä¸€å¼ æ— ä¸ä¼¦æ¯”çš„æµ·æŠ¥äº†å—ï¼Ÿ</h1>

        <h1 id="newTitle" class="title-text"><span class="text-content">çµæ„Ÿæ— é™ï¼Œåˆ›æ„æ— ç–†ï¼</span></h1>

        <p id="loadingSubtext"><span class="text-content">æµ·æŠ¥æ­£åœ¨ç”Ÿæˆä¸­...</span></p>
      </div>
    </header>

    <section class="creation-area" id="creationArea">
      <div class="magic-input-box-wrapper" id="inputWrapper">
        <!-- å›¾ç‰‡é¢„è§ˆåŒºåŸŸ -->
        <div class="image-preview-container" id="imagePreviewContainer" style="display: none;">
          <div class="image-preview-card">
            <img id="previewImage" src="" alt="å‚è€ƒå›¾ç‰‡">
            <button class="remove-image-btn" id="removeImageBtn" title="ç§»é™¤å›¾ç‰‡">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <line x1="18" y1="6" x2="6" y2="18"></line>
                <line x1="6" y1="6" x2="18" y2="18"></line>
              </svg>
            </button>
            <div class="image-label">å‚è€ƒå›¾ç‰‡ï¼ˆå›¾ç”Ÿå›¾ï¼‰</div>
          </div>
        </div>

        <textarea class="magic-textarea" id="promptInput" placeholder="æè¿°ä½ æƒ³è¦çš„ç”»é¢ï¼Œä¾‹å¦‚ï¼šèµ›åšæœ‹å…‹é£æ ¼çš„åŸå¸‚å¤œæ™¯ï¼Œéœ“è™¹ç¯å…‰..."></textarea>

        <!-- éšè—çš„æ–‡ä»¶è¾“å…¥ -->
        <input type="file" id="imageUpload" accept="image/*" style="display: none;">

        <div class="popover-menu" id="popoverMenu">
          <ul class="popover-list">
            <li class="popover-item" id="uploadImageItem">
              <svg class="popover-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"></path>
              </svg>
              ä¸Šä¼ å‚è€ƒå›¾ç‰‡ï¼ˆå›¾ç”Ÿå›¾ï¼‰
            </li>
          </ul>
        </div>
        <div class="input-box-actions">
          <div class="left-actions">
            <button class="action-icon-btn" id="plusBtn"><svg class="action-svg-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg></button>
          </div>
          <div class="right-actions">
            <button class="pro-brain-btn" id="modeToggleBtn"><svg class="brain-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9.5 2A2.5 2.5 0 0 1 12 4.5v15a2.5 2.5 0 0 1-4.96.44 2.5 2.5 0 0 1-2.96-3.08 3 3 0 0 1-.34-5.55 2.5 2.5 0 0 1 1.32-4.24 2.5 2.5 0 0 1 1.98-3A2.5 2.5 0 0 1 9.5 2Z"></path><path d="M14.5 2A2.5 2.5 0 0 0 12 4.5v15a2.5 2.5 0 0 0 4.96.44 2.5 2.5 0 0 0 2.96-3.08 3 3 0 0 0 .34-5.55 2.5 2.5 0 0 0-1.32-4.24 2.5 2.5 0 0 0-1.98-3A2.5 2.5 0 0 0 14.5 2Z"></path></svg><svg class="lightning-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"></polygon></svg><span class="tooltip">åˆ‡æ¢ Thinking/Fast æ¨¡å¼</span></button>
            <button class="generate-arrow-btn" id="generateBtn"><svg class="mic-icon" id="micIcon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path><path d="M19 10v2a7 7 0 0 1-14 0v-2"></path><line x1="12" y1="19" x2="12" y2="23"></line><line x1="8" y1="23" x2="16" y2="23"></line></svg><svg class="arrow-up-icon" id="arrowIcon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="19" x2="12" y2="5"></line><polyline points="5 12 12 5 19 12"></polyline></svg><span class="tooltip">ç”Ÿæˆæµ·æŠ¥</span></button>
          </div>
        </div>
      </div>
    </section>

    <section class="results-view" id="resultsSection">
      <div class="results-header">
        <h2 id="resultTitle">åˆ›ä½œå®Œæˆï¼</h2>
        <p>ä¸ºæ‚¨ç”Ÿæˆäº† 4 å¼ ä¸åŒé£æ ¼çš„æµ·æŠ¥</p>
      </div>
      <div class="results-grid">
        <div class="result-card"><div class="result-placeholder">Poster 1</div></div>
        <div class="result-card"><div class="result-placeholder">Poster 2</div></div>
        <div class="result-card"><div class="result-placeholder">Poster 3</div></div>
        <div class="result-card"><div class="result-placeholder">Poster 4</div></div>
      </div>
      <div class="regenerate-bar">
        <button class="back-btn" id="backBtn">è¿”å›</button>
        <input type="text" class="regen-input" value="èµ›åšæœ‹å…‹é£æ ¼çš„åŸå¸‚å¤œæ™¯ï¼Œéœ“è™¹ç¯å…‰...">
        <button class="regen-btn">é‡æ–°ç”Ÿæˆ</button>
      </div>
    </section>

  </main>

<script>
  // Basic Sidebar & UI Logic
  function updateSlider(slider, valId) { const value = (slider.value - slider.min) / (slider.max - slider.min) * 100; slider.style.backgroundSize = value + '% 100%'; const display = document.getElementById(valId); if (slider.step && slider.step < 1) { display.innerText = parseFloat(slider.value).toFixed(2); } else { display.innerText = slider.value; } }
  const toggleBtn = document.getElementById('toggleSidebar'); const sidebar = document.body; toggleBtn.addEventListener('click', () => { sidebar.classList.toggle('sidebar-collapsed'); });
  const summaryHeaders = document.querySelectorAll('summary'); summaryHeaders.forEach(summary => { summary.addEventListener('click', (e) => { if (document.body.classList.contains('sidebar-collapsed')) { e.preventDefault(); document.body.classList.remove('sidebar-collapsed'); summary.parentElement.open = true; } }); });
  document.addEventListener('DOMContentLoaded', () => { const sliders = document.querySelectorAll('.slider-range'); sliders.forEach(slider => { const valId = slider.id.replace('-slider', '-val'); updateSlider(slider, valId); }); });
  const textarea = document.querySelector('.magic-textarea'); const generateBtn = document.getElementById('generateBtn'); textarea.addEventListener('input', function() { if (this.value.trim().length > 0) { generateBtn.classList.add('show-arrow'); } else { generateBtn.classList.remove('show-arrow'); } });
  const modeBtn = document.getElementById('modeToggleBtn'); modeBtn.addEventListener('click', () => { modeBtn.classList.toggle('show-lightning'); });
  const plusBtn = document.getElementById('plusBtn'); const popoverMenu = document.getElementById('popoverMenu'); plusBtn.addEventListener('click', (e) => { e.stopPropagation(); popoverMenu.classList.toggle('active'); }); document.addEventListener('click', (e) => { if (!popoverMenu.contains(e.target) && !plusBtn.contains(e.target)) { popoverMenu.classList.remove('active'); } });

  // ==========================================
  //  å›¾ç‰‡ä¸Šä¼ åŠŸèƒ½ï¼ˆå›¾ç”Ÿå›¾ï¼‰
  // ==========================================
  const uploadImageItem = document.getElementById('uploadImageItem');
  const imageUpload = document.getElementById('imageUpload');
  const imagePreviewContainer = document.getElementById('imagePreviewContainer');
  const previewImage = document.getElementById('previewImage');
  const removeImageBtn = document.getElementById('removeImageBtn');
  let referenceImageBase64 = null; // å­˜å‚¨ Base64 ç¼–ç çš„å›¾ç‰‡

  // ç‚¹å‡»èœå•é¡¹è§¦å‘æ–‡ä»¶é€‰æ‹©
  uploadImageItem.addEventListener('click', () => {
    imageUpload.click();
    popoverMenu.classList.remove('active'); // å…³é—­èœå•
  });

  // å¤„ç†æ–‡ä»¶é€‰æ‹©
  imageUpload.addEventListener('change', (e) => {
    const file = e.target.files[0];
    if (file && file.type.startsWith('image/')) {
      const reader = new FileReader();

      reader.onload = (event) => {
        referenceImageBase64 = event.target.result; // ä¿å­˜ Base64 å­—ç¬¦ä¸²
        previewImage.src = referenceImageBase64;
        imagePreviewContainer.style.display = 'block'; // æ˜¾ç¤ºé¢„è§ˆ
      };

      reader.readAsDataURL(file); // è¯»å–ä¸º Base64
    }
  });

  // ç§»é™¤å›¾ç‰‡
  removeImageBtn.addEventListener('click', () => {
    referenceImageBase64 = null;
    previewImage.src = '';
    imagePreviewContainer.style.display = 'none';
    imageUpload.value = ''; // æ¸…ç©ºæ–‡ä»¶è¾“å…¥
  });

  // ==========================================
  //  æ ¸å¿ƒäº¤äº’é€»è¾‘ï¼šæå…‰ -> éœ“è™¹ -> ç»“æœé¡µåˆ‡æ¢
  // ==========================================
  const auroraLayer = document.getElementById('auroraLayer');
  const inputWrapper = document.getElementById('inputWrapper');
  const mainTitle = document.getElementById('mainTitle');
  const newTitle = document.getElementById('newTitle');
  const loadingSubtext = document.getElementById('loadingSubtext');
  const creationArea = document.getElementById('creationArea');
  const resultsSection = document.getElementById('resultsSection');
  const backBtn = document.getElementById('backBtn');

  // 1. èšç„¦è¾“å…¥æ¡†ï¼šæå…‰èµ·ä¼ (Wave Active)
  textarea.addEventListener('focus', () => {
    if (!auroraLayer.classList.contains('absorbed')) {
        auroraLayer.classList.add('wave-active');
    }
  });

  textarea.addEventListener('blur', () => {
     if (textarea.value.trim().length === 0) {
       auroraLayer.classList.remove('wave-active');
     }
  });

  // 2. ç‚¹å‡»ç”Ÿæˆï¼šè§¦å‘åŠ¨ç”»åºåˆ— + APIè°ƒç”¨
  generateBtn.addEventListener('click', async () => {
    const prompt = textarea.value.trim();
    if (!prompt) {
      alert('è¯·è¾“å…¥æµ·æŠ¥æè¿°');
      return;
    }

    // æ”¶é›†æ‰€æœ‰å‚æ•°
    const aspectRatio = document.getElementById('aspect-ratio-select').value;
    const count = parseInt(document.getElementById('count-slider').value);
    const presetStyle = document.getElementById('preset-style-select').value;
    const styleIntensity = parseFloat(document.getElementById('strength-slider').value);
    const thinkingMode = !modeBtn.classList.contains('show-lightning'); // è„‘å›¾æ ‡=thinking, é—ªç”µ=fast

    // Phase 1: Aurora Shrink & Title Fade
    auroraLayer.classList.remove('wave-active');
    auroraLayer.classList.add('absorbed');
    mainTitle.classList.add('fade-in-input');

    // Phase 2: Neon Spin & New Title (0.8s)
    setTimeout(() => {
        newTitle.classList.add('pop-out');
        loadingSubtext.classList.add('show');

        // æ¿€æ´»æ‰«æå…‰æ•ˆ
        newTitle.classList.add('scan-effect');
        loadingSubtext.classList.add('scan-effect');

        inputWrapper.classList.add('neon-active');
    }, 1500);

    // Phase 3: Call Backend API
    setTimeout(async () => {
        try {
            // å‘é€APIè¯·æ±‚
            const response = await fetch('http://localhost:8000/api/generate', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    prompt: prompt,
                    aspect_ratio: aspectRatio,
                    count: count,
                    preset_style: mapStyleValue(presetStyle),
                    style_intensity: styleIntensity,
                    negative_prompt: null,
                    thinking_mode: thinkingMode,
                    reference_image: referenceImageBase64  // æ·»åŠ å‚è€ƒå›¾ç‰‡
                })
            });

            if (!response.ok) {
                throw new Error(`APIé”™è¯¯: ${response.status}`);
            }

            const data = await response.json();

            // æ˜¾ç¤ºç»“æœ
            displayResults(data.images, count);

            // Fade out input area
            creationArea.classList.add('fade-out');
            newTitle.classList.remove('pop-out');
            newTitle.style.opacity = '0';
            loadingSubtext.classList.remove('show');
            loadingSubtext.style.opacity = '0';

            // Show Results
            setTimeout(() => {
                creationArea.style.display = 'none';
                resultsSection.classList.add('active');
            }, 500);

        } catch (error) {
            console.error('ç”Ÿæˆå¤±è´¥:', error);
            alert(`ç”Ÿæˆå¤±è´¥: ${error.message}\n\nè¯·ç¡®ä¿ï¼š\n1. åç«¯æœåŠ¡å™¨æ­£åœ¨è¿è¡Œ (python server.py)\n2. åœ°å€ä¸º http://localhost:8000`);

            // é‡ç½®UIçŠ¶æ€
            resetUIAfterError();
        }
    }, 2300); // 1.5s + 800ms for neon animation
  });

  // é£æ ¼å€¼æ˜ å°„å‡½æ•°
  function mapStyleValue(value) {
    const styleMap = {
      'auto': 'Auto',
      'minimal': 'Minimalist',
      'tech': 'Tech',
      'warm': 'Hand-drawn'
    };
    return styleMap[value] || 'Auto';
  }

  // æ˜¾ç¤ºç»“æœå›¾ç‰‡
  function displayResults(base64Images, count) {
    const resultsGrid = document.querySelector('.results-grid');
    resultsGrid.innerHTML = ''; // æ¸…ç©ºç°æœ‰å†…å®¹

    base64Images.forEach((imgBase64, index) => {
      const card = document.createElement('div');
      card.className = 'result-card';

      const img = document.createElement('img');
      img.src = imgBase64;
      img.style.width = '100%';
      img.style.height = '100%';
      img.style.objectFit = 'cover';

      card.appendChild(img);
      resultsGrid.appendChild(card);
    });

    // æ›´æ–°æç¤ºæ–‡å­—
    document.querySelector('.results-header p').innerText = `ä¸ºæ‚¨ç”Ÿæˆäº† ${base64Images.length} å¼ ä¸åŒé£æ ¼çš„æµ·æŠ¥`;
  }

  // é”™è¯¯åé‡ç½®UI
  function resetUIAfterError() {
    auroraLayer.classList.remove('absorbed');
    auroraLayer.classList.add('wave-active');
    mainTitle.classList.remove('fade-in-input');
    newTitle.classList.remove('pop-out');
    newTitle.classList.remove('scan-effect');
    newTitle.style.opacity = '';
    loadingSubtext.classList.remove('show');
    loadingSubtext.classList.remove('scan-effect');
    loadingSubtext.style.opacity = '';
    inputWrapper.classList.remove('neon-active');
  }

  // 3. è¿”å›è¾“å…¥çŠ¶æ€ (Reset)
  backBtn.addEventListener('click', () => {
    // Reset View
    resultsSection.classList.remove('active');
    setTimeout(() => {
        creationArea.style.display = 'block';
        setTimeout(() => creationArea.classList.remove('fade-out'), 50);

        // Reset Aurora & Titles
        auroraLayer.classList.remove('absorbed');
        mainTitle.classList.remove('fade-in-input');
        newTitle.style.opacity = '';
        newTitle.classList.remove('scan-effect');
        loadingSubtext.style.opacity = '';
        loadingSubtext.classList.remove('scan-effect');
        inputWrapper.classList.remove('neon-active');
    }, 300);
  });

</script>
</body>
</html>
